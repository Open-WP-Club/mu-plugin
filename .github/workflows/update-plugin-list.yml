name: Update Plugin List

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'mu-plugins/**'
      - '.github/workflows/update-plugin-list.yml'
  pull_request:
    branches: [ main, master ]
    paths: 
      - 'mu-plugins/**'
  workflow_dispatch:

jobs:
  update-plugin-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Create and run plugin scanner
      run: |
        cat << 'ENDOFSCRIPT' > scan-plugins.js
        const fs = require('fs');
        const path = require('path');

        function extractPluginInfo(filePath, content) {
          const lines = content.split('\n');
          const plugin = {
            file: path.basename(filePath),
            name: '',
            description: '',
            version: '',
            requiresWP: '',
            requiresPHP: '',
            uri: '',
            textDomain: ''
          };

          let inHeader = false;
          let headerContent = [];
          
          for (let line of lines) {
            const trimmedLine = line.trim();
            
            if (trimmedLine.startsWith('/**')) {
              inHeader = true;
              continue;
            }
            
            if (trimmedLine.endsWith('*/') && inHeader) {
              break;
            }
            
            if (inHeader) {
              headerContent.push(trimmedLine.replace(/^\*\s?/, ''));
            }
          }

          const headerText = headerContent.join('\n');
          
          const patterns = {
            name: /Plugin name:\s*(.+?)$/im,
            description: /Description:\s*(.+?)$/im,
            version: /Version:\s*(.+?)\.?$/im,
            requiresWP: /Requires at least:\s*(.+?)$/im,
            requiresPHP: /Requires PHP:\s*(.+?)$/im,
            uri: /Plugin URI:\s*(.+?)$/im,
            textDomain: /Text Domain:\s*(.+?)$/im
          };

          for (const [key, pattern] of Object.entries(patterns)) {
            const match = headerText.match(pattern);
            if (match) {
              plugin[key] = match[1].trim();
            }
          }

          return plugin;
        }

        function scanPluginsDirectory() {
          const pluginsDir = path.join(process.cwd(), 'mu-plugins');
          
          if (!fs.existsSync(pluginsDir)) {
            console.log('mu-plugins directory not found');
            return [];
          }

          const plugins = [];
          const files = fs.readdirSync(pluginsDir, { withFileTypes: true });

          for (const file of files) {
            if (file.isFile() && file.name.endsWith('.php')) {
              const filePath = path.join(pluginsDir, file.name);
              const content = fs.readFileSync(filePath, 'utf8');
              
              if (content.includes('Plugin name:') || content.includes('Plugin Name:')) {
                const pluginInfo = extractPluginInfo(filePath, content);
                if (pluginInfo.name) {
                  plugins.push(pluginInfo);
                }
              }
            }
          }

          return plugins.sort((a, b) => a.name.localeCompare(b.name));
        }

        function generateMarkdownTable(plugins) {
          if (plugins.length === 0) {
            return '> No mu-plugins found in the mu-plugins directory.';
          }

          let markdown = '| Plugin Name | Description | Version | WP Version | PHP Version |\n';
          markdown += '|-------------|-------------|---------|------------|-------------|\n';

          for (const plugin of plugins) {
            const name = `[${plugin.name}](mu-plugins/${plugin.file})`;
            const description = plugin.description || 'N/A';
            const version = plugin.version || 'N/A';
            const requiresWP = plugin.requiresWP || 'N/A';
            const requiresPHP = plugin.requiresPHP || 'N/A';
            
            markdown += `| ${name} | ${description} | ${version} | ${requiresWP}+ | ${requiresPHP}+ |\n`;
          }

          return markdown;
        }

        function updateReadme(pluginTable) {
          const readmePath = path.join(process.cwd(), 'README.MD');
          
          if (!fs.existsSync(readmePath)) {
            console.log('README.MD not found, creating new one...');
            const newReadme = '# WordPress MU-Plugins Collection\n\n' +
              '## Available Plugins\n\n' +
              '<!-- PLUGIN_LIST_START -->\n' +
              pluginTable + '\n' +
              '<!-- PLUGIN_LIST_END -->\n\n' +
              '## Installation\n\n' +
              '1. Download the desired plugin files\n' +
              '2. Upload them to your `wp-content/mu-plugins/` directory\n' +
              '3. The plugins will be automatically activated\n\n' +
              '## Contributing\n\n' +
              'Feel free to contribute new mu-plugins or improve existing ones!\n';
            
            fs.writeFileSync(readmePath, newReadme);
            console.log('Created new README.MD with plugin list');
            return;
          }

          let content = fs.readFileSync(readmePath, 'utf8');
          
          const startMarker = '<!-- PLUGIN_LIST_START -->';
          const endMarker = '<!-- PLUGIN_LIST_END -->';
          
          const startIndex = content.indexOf(startMarker);
          const endIndex = content.indexOf(endMarker);
          
          if (startIndex !== -1 && endIndex !== -1) {
            const before = content.substring(0, startIndex + startMarker.length);
            const after = content.substring(endIndex);
            content = before + '\n' + pluginTable + '\n' + after;
            
            fs.writeFileSync(readmePath, content);
            console.log('Updated README.MD with new plugin list');
          } else {
            content += '\n\n## Available Plugins\n\n' + startMarker + '\n' + pluginTable + '\n' + endMarker + '\n';
            fs.writeFileSync(readmePath, content);
            console.log('Added plugin list section to README.MD');
          }
        }

        console.log('Scanning mu-plugins directory...');
        const plugins = scanPluginsDirectory();
        console.log(`Found ${plugins.length} plugins`);

        if (plugins.length > 0) {
          console.log('Plugins found:');
          plugins.forEach(plugin => {
            console.log(`  - ${plugin.name} (${plugin.version})`);
          });
        }

        const pluginTable = generateMarkdownTable(plugins);
        updateReadme(pluginTable);
        
        console.log('Plugin list update completed!');
        ENDOFSCRIPT

        node scan-plugins.js

    - name: Check for changes
      id: verify-changed-files
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.MD
        git commit -m "ðŸ¤– Update plugin list automatically" || exit 0
        git push